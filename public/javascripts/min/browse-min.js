var browse={toteBags:null,sort:function(e){var t=e.attr("data-attr"),o=e.attr("data-dir");"likes"===t?browse.toteBags=_.sortBy(browse.toteBags,function(e){return parseInt(e.likes)}):browse.toteBags=_.sortBy(browse.toteBags,t),"desc"===o&&(browse.toteBags=browse.toteBags.reverse()),browse.animateOut(function(){$(".browse-tote-wrap").empty(),browse.buildBagGrid()}),$("nav .sort .name").html(e.html())},gridOrderHelper:function(e){var t=$(".tote-grid-element").width(),o=Math.round($(window).width()/t),a=e%(2*o);return o>a?e:e+(o-1-2*(a-o))},animateIn:function(e,t){e=e||0,browse.animateInHelper(e,t)},animateInHelper:function(e,t){var o=$(".tote-grid-element").length;return e>=o?void setTimeout(function(){t&&void 0!==t&&t()},20*e):void setTimeout(function(){var o=browse.gridOrderHelper(e);0===$(".tote-grid-element").eq(o).length&&(o=e),$(".tote-grid-element").eq(o).removeClass("start"),browse.animateInHelper(e+1,t)},20*e)},animateOut:function(e){var t=$(".tote-grid-element").length;browse.animateOutHelper(t-1,e)},animateOutHelper:function(e,t){var o=$(".tote-grid-element").length;return 0>e?void setTimeout(function(){t&&void 0!==t&&t()},20*o):void setTimeout(function(){var o=browse.gridOrderHelper(e);$(".tote-grid-element").eq(o).addClass("start"),browse.animateOutHelper(e-1,t)},10*(o-e))},loadBags:function(e){null===browse.toteBags?$.getJSON("/totes",function(t){browse.toteBags=_.sortBy(t,function(e){return e.timestamp}),browse.toteBags=browse.toteBags.reverse(),"undefined"!=typeof e&&e()}):"undefined"!=typeof e&&e()},buildBagGrid:function(){_.each(browse.toteBags,function(e){e.swingTimer=null;var t={bags:[e]};$.get("/templates/_bag.html",function(o){var a=Handlebars.compile(o),i=a(t),r="<div class='heart-outer-wrap'><div class='heart-wrap'>",s=t.bags[0]._id;likes.indexOf(s)>-1&&(r="<div class='heart-outer-wrap favorited'><div class='heart-wrap'>"),r+="<div class='heart-circle'></div><div class='heart'><div class='inner-heart grey'></div><div class='inner-heart magenta'></div><div class='inner-heart white'></div></div></div></div>";var n=$("<div />",{"class":"tote-grid-element start "+t.bags[0].color,html:r+i}).appendTo(".browse-page.content .browse-tote-wrap");e==browse.toteBags[browse.toteBags.length-1]&&($(".browse-page.content .browse-tote-wrap .clearfix").remove(),$(".browse-page.content .browse-tote-wrap").append("<div class='clearfix'></div>"),site.refreshTypeOnTotes(),browse.animateIn())})})},view:function(e){var t=e.index(),o=t-1;0>o&&(o=e.siblings().length-1);var a=$(".browse-tote-wrap .tote-grid-element").eq(o),i=t+1;i>e.siblings().length-1&&(i=0);var r=$(".browse-tote-wrap .tote-grid-element").eq(i),s=$("<div />",{"class":a.attr("class")+" view","data-id":o,html:a.html()}),n=$("<div />",{"class":e.attr("class")+" view","data-id":t,html:e.html()}),d=$("<div />",{"class":r.attr("class")+" view","data-id":i,html:r.html()});$(".view-carousel").addClass("on"),$(".view-carousel-wrap").append(s).append(n).append(d),TweenLite.to(".view-carousel-wrap .tote-grid-element .actual-tote, .view-carousel-wrap .tote-grid-element .tote-shadow",0,{rotation:"0deg"}),$(".view-carousel-wrap .tote-grid-element.swinging").removeClass("swinging"),site.refreshTypeOnTotes(),n.find(".heart-outer-wrap").hasClass("favorited")&&n.parents(".view-carousel").find(".view-controls .heart-outer-wrap").addClass("favorited"),window.history.pushState("html","Title","/totes/"+browse.toteBags[t]._id),$("body").addClass("lock-scroll");var l=n.height(),w=n.find(".tote-wrap").height();console.log(l,w),$(".view-carousel-wrap").scrollTop((l-w)/2),$(".view-carousel").attr("data-display",t)},viewZoomIn:function(e){var t=e.offset().left,o=e.offset().top-$(window).scrollTop(),a=e.outerHeight(),i=e.outerWidth(),r=$("<div />",{id:"zoomAnimation","class":e.attr("class")+"",html:e.html()});r.height(a),r.width(i),$(".content.browse-page .zoomTransition .zoomAnimationWrapper").append(r),$(".zoomTransition").addClass("debug"),TweenLite.to(r,0,{x:t,y:o}),r.removeClass("swinging"),TweenLite.to(r.find(".actual-tote"),.3,{rotation:"0deg"}),TweenLite.to(r.find(".tote-shadow"),.3,{rotation:"0deg"}),site.refreshTypeOnTotes(),$("body").addClass("lock-scroll");var s=r.outerWidth(),n=r.outerHeight(),d=$(window).width(),l=Math.round(d/s),w=s*l,g=n*l;TweenLite.fromTo(r,.5,{x:t,y:o,height:a,scale:1,ease:cssBezier},{x:1*(l-1)/2*s,y:0,height:150/l+"vh",scale:l,ease:cssBezier,onComplete:function(){site.refreshTypeOnTotes(),$(".zoomTransition").animate({scrollTop:1e3},500),$(".zoomTransition").addClass("debug"),browse.view(e),setTimeout(function(){$("#zoomAnimation").remove()},1e3)}})},viewZoomOut:function(e){},swingOnce:function(e){var t=e.find(".actual-tote"),o=e.find(".tote-shadow");TweenLite.to(o,.5,{rotation:"-4deg",scaleX:.9,ease:gridBagBezier}),TweenLite.to(t,.5,{rotation:"5deg",ease:gridBagBezier,onComplete:function(){TweenLite.to(o,.5,{rotation:"0deg",scaleX:1,ease:gridBagBezier,onComplete:function(){TweenLite.to(o,.5,{rotation:"4deg",scaleX:.9,ease:gridBagBezier})}}),TweenLite.to(t,1,{rotation:"-5deg",ease:gridBagBezier,onComplete:function(){TweenLite.to(o,.5,{rotation:"0deg",scaleX:1,ease:gridBagBezier,onComplete:function(){}}),TweenLite.to(t,.5,{rotation:"0deg",ease:gridBagBezier})}})}})},swing:function(e){var t;t="undefined"==typeof e.attr("data-id")?e.index():parseInt(e.attr("data-id")),e.hasClass("swinging")?clearTimeout(browse.toteBags[t].stopTimer):(browse.swingOnce(e),e.addClass("swinging"),browse.toteBags[t].swingTimer=setInterval(function(){browse.swingOnce(e)},1900))},stopSwing:function(e){var t;t="undefined"==typeof e.attr("data-id")?e.index():parseInt(e.attr("data-id")),browse.toteBags[t].stopTimer=setTimeout(function(){e.removeClass("swinging"),clearInterval(browse.toteBags[t].swingTimer)},500)}};$(document).ready(function(){likes.fetchUserLikes(),browse.loadBags(browse.buildBagGrid),$(".sort ul li").hammer().on("tap",function(){browse.sort($(this))}),$(document).hammer().on("tap",".heart-outer-wrap",function(e){e.preventDefault(),e.stopPropagation();var t;if($(this).parents(".view-controls").length>0){var o=$(this).parents(".view-carousel").attr("data-display");t=parseInt(o)}else{var a=$(this).parents(".tote-grid-element");t=a.index()}var i=browse.toteBags[t],r=i._id;$(this).hasClass("favorited")?(likes.unfavorite($(this).find(".heart-wrap")),likes.unlikeBag(r)):(likes.favorite($(this).find(".heart-wrap")),likes.likeBag(r))}),$(document).on("mouseenter",".browse-tote-wrap .tote-grid-element",function(){browse.swing($(this))}),$(document).on("mouseleave",".browse-tote-wrap .tote-grid-element",function(){browse.stopSwing($(this))}),$(".tote-grid-element").hover(function(){browse.swing($(this))},function(){browse.stopSwing($(this))}),$(document).hammer().on("tap",".browse-tote-wrap .tote-grid-element",function(e){e.preventDefault(),e.stopPropagation(),browse.viewZoomIn($(this))})});